name: Build and Push to ECR

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  AWS_REGION: us-east-1                   # CHANGE THIS: Your AWS region
  ECR_REPOSITORY: fastapi-app              # CHANGE THIS: Your ECR repository name
  APP_RUNNER_SERVICE: fastapi-app-service  # CHANGE THIS: Your App Runner service name

permissions:
  id-token: write   # Required for OIDC
  contents: read    # Required for checkout

jobs:
  build-and-push:
    name: Build Docker Image and Push to ECR
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::790261630365:role/GitHubActionsECRRole  # CHANGE THIS: Replace with your IAM Role ARN
        aws-region: ${{ env.AWS_REGION }}
        role-session-name: GitHubActions-ECR-Push
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: Build Docker image
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "Building Docker image..."
        echo "ECR Registry: $ECR_REGISTRY"
        echo "Repository: $ECR_REPOSITORY"
        echo "Tag: $IMAGE_TAG"
        
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
    
    - name: Push Docker image to ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "Pushing Docker image to ECR..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        echo "Image pushed successfully!"
        echo "Image URI: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
    
    - name: Output image details
      run: |
        echo "âœ… Successfully pushed image to ECR"
        echo "Repository: ${{ env.ECR_REPOSITORY }}"
        echo "Tag: ${{ github.sha }}"
        echo "Full URI: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"
    
    - name: Deploy to App Runner
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
        APP_RUNNER_SERVICE: ${{ env.APP_RUNNER_SERVICE }}
        AWS_REGION: ${{ env.AWS_REGION }}
      run: |
        echo "ðŸš€ Deploying to App Runner..."
        IMAGE_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
        echo "Image URI: $IMAGE_URI"
        
        # Get App Runner service ARN
        SERVICE_ARN=$(aws apprunner list-services \
          --region $AWS_REGION \
          --query "ServiceSummaryList[?ServiceName=='$APP_RUNNER_SERVICE'].ServiceArn" \
          --output text)
        
        if [ -z "$SERVICE_ARN" ]; then
          echo "âŒ Error: App Runner service '$APP_RUNNER_SERVICE' not found!"
          exit 1
        fi
        
        echo "Service ARN: $SERVICE_ARN"
        
        # Get current service configuration
        echo "Getting current service configuration..."
        aws apprunner describe-service \
          --service-arn $SERVICE_ARN \
          --region $AWS_REGION > /tmp/service-config.json
        
        # Update service with new image URI
        echo "Updating service with new image: $IMAGE_URI"
        aws apprunner update-service \
          --service-arn $SERVICE_ARN \
          --region $AWS_REGION \
          --source-configuration '{
            "ImageRepository": {
              "ImageIdentifier": "'"$IMAGE_URI"'",
              "ImageConfiguration": {
                "Port": "8000"
              },
              "ImageRepositoryType": "ECR"
            },
            "AutoDeploymentsEnabled": true
          }' > /tmp/update-response.json
        
        echo "âœ… Service updated successfully"
        
        # Start deployment
        echo "Starting deployment..."
        aws apprunner start-deployment \
          --service-arn $SERVICE_ARN \
          --region $AWS_REGION
        
        echo "âœ… Deployment initiated to App Runner"
        echo "Service will be available at: https://$(aws apprunner describe-service --service-arn $SERVICE_ARN --region $AWS_REGION --query 'Service.ServiceUrl' --output text)"