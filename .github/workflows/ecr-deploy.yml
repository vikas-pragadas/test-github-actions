name: Build and Push to ECR

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  AWS_REGION: us-east-1                   # CHANGE THIS: Your AWS region
  ECR_REPOSITORY: fastapi-app              # CHANGE THIS: Your ECR repository name
  APP_RUNNER_SERVICE: fastapi-app-service  # CHANGE THIS: Your App Runner service name

permissions:
  id-token: write   # Required for OIDC
  contents: read    # Required for checkout

jobs:
  build-and-push:
    name: Build Docker Image and Push to ECR
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::790261630365:role/GitHubActionsECRRole  # CHANGE THIS: Replace with your IAM Role ARN
        aws-region: ${{ env.AWS_REGION }}
        role-session-name: GitHubActions-ECR-Push
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: Build Docker image
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "Building Docker image..."
        echo "ECR Registry: $ECR_REGISTRY"
        echo "Repository: $ECR_REPOSITORY"
        echo "Tag: $IMAGE_TAG"
        
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
    
    - name: Push Docker image to ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "Pushing Docker image to ECR..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        echo "Image pushed successfully!"
        echo "Image URI: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
    
    - name: Output image details
      run: |
        echo "‚úÖ Successfully pushed image to ECR"
        echo "Repository: ${{ env.ECR_REPOSITORY }}"
        echo "Tag: ${{ github.sha }}"
        echo "Full URI: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"
    
    - name: Deploy to App Runner
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
        APP_RUNNER_SERVICE: ${{ env.APP_RUNNER_SERVICE }}
        AWS_REGION: ${{ env.AWS_REGION }}
      run: |
        echo "üöÄ Deploying to App Runner..."
        IMAGE_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
        echo "Image URI: $IMAGE_URI"
        
        # List all App Runner services to help debug
        echo "Listing all App Runner services..."
        aws apprunner list-services --region $AWS_REGION --query "ServiceSummaryList[*].[ServiceName,ServiceArn]" --output table
        
        # Get App Runner service ARN
        SERVICE_ARN=$(aws apprunner list-services \
          --region $AWS_REGION \
          --query "ServiceSummaryList[?ServiceName=='$APP_RUNNER_SERVICE'].ServiceArn" \
          --output text)
        
        if [ -z "$SERVICE_ARN" ]; then
          echo "‚ùå Error: App Runner service '$APP_RUNNER_SERVICE' not found!"
          echo "Please create the App Runner service first, or update APP_RUNNER_SERVICE in the workflow to match your existing service name."
          echo ""
          echo "To create the service:"
          echo "1. Go to AWS App Runner Console"
          echo "2. Click 'Create service'"
          echo "3. Select your ECR repository: $ECR_REPOSITORY"
          echo "4. Name the service: $APP_RUNNER_SERVICE"
          echo "5. Configure port: 8000"
          echo "6. Select IAM role: AppRunnerServiceRole"
          exit 1
        fi
        
        echo "Service ARN: $SERVICE_ARN"
        
        # Wait for service to be ready (not in OPERATION_IN_PROGRESS state)
        echo "Checking service status..."
        MAX_WAIT=300  # 5 minutes max wait
        WAIT_TIME=0
        SLEEP_INTERVAL=10
        
        while [ $WAIT_TIME -lt $MAX_WAIT ]; do
          SERVICE_STATUS=$(aws apprunner describe-service \
            --service-arn $SERVICE_ARN \
            --region $AWS_REGION \
            --query 'Service.Status' \
            --output text 2>/dev/null || echo "UNKNOWN")
          
          echo "Current service status: $SERVICE_STATUS"
          
          if [ "$SERVICE_STATUS" = "RUNNING" ]; then
            echo "‚úÖ Service is ready for update"
            break
          elif [ "$SERVICE_STATUS" = "CREATE_FAILED" ] || [ "$SERVICE_STATUS" = "UPDATE_FAILED" ]; then
            echo "‚ö†Ô∏è Service is in $SERVICE_STATUS state. Attempting to update anyway..."
            break
          fi
          
          echo "Service is in $SERVICE_STATUS state. Waiting $SLEEP_INTERVAL seconds..."
          sleep $SLEEP_INTERVAL
          WAIT_TIME=$((WAIT_TIME + SLEEP_INTERVAL))
        done
        
        # Update service with new image URI
        echo "Updating service with new image: $IMAGE_URI"
        UPDATE_OUTPUT=$(aws apprunner update-service \
          --service-arn $SERVICE_ARN \
          --region $AWS_REGION \
          --source-configuration '{
            "ImageRepository": {
              "ImageIdentifier": "'"$IMAGE_URI"'",
              "ImageConfiguration": {
                "Port": "8000"
              },
              "ImageRepositoryType": "ECR"
            },
            "AutoDeploymentsEnabled": true
          }' 2>&1)
        
        UPDATE_EXIT_CODE=$?
        
        if [ $UPDATE_EXIT_CODE -eq 0 ]; then
          echo "‚úÖ Service updated successfully"
          echo "‚úÖ Deployment started automatically by App Runner"
          echo ""
          echo "Note: App Runner will automatically deploy the new image."
          echo "This may take 5-10 minutes. You can monitor the deployment in the App Runner console."
          SERVICE_URL=$(aws apprunner describe-service --service-arn $SERVICE_ARN --region $AWS_REGION --query 'Service.ServiceUrl' --output text)
          echo ""
          echo "Service URL: https://$SERVICE_URL"
          echo "Once deployment completes, your updated endpoints will be available."
        else
          if echo "$UPDATE_OUTPUT" | grep -q "InvalidStateException"; then
            echo "‚ö†Ô∏è Service is currently being updated (OPERATION_IN_PROGRESS)."
            echo "The new image has been pushed to ECR: $IMAGE_URI"
            echo "If auto-deploy is enabled, App Runner will automatically deploy the new image when ready."
            echo "Otherwise, the deployment will be retried on the next push."
            echo "‚úÖ Image successfully pushed to ECR - deployment will happen automatically"
          else
            echo "‚ùå Error updating service:"
            echo "$UPDATE_OUTPUT"
            exit 1
          fi
        fi